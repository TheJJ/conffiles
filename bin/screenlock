#!/usr/bin/env python3

"""
lock the screen with i3lock
optionally display a lockscreen image if it exists
"""

import argparse
import subprocess
from pathlib import Path


def main():
    """
    entry point
    """
    cli = argparse.ArgumentParser(description='lockscreen with i3')
    cli.add_argument('--suspend', action="store_true")
    args = cli.parse_args()

    lockimage = Path("~/.config/lockscreen/1.png").expanduser()

    # with xcompmgr, dunst actually overlays i3lock.
    # so we need to pause dunst.
    dunst_state = subprocess.run(
        ["systemctl", "--user", "is-active", "dunst.service"],
        capture_output=True,
    )

    dunst_active = dunst_state.returncode == 0 and dunst_state.stdout == b"active"

    if dunst_active:
        subprocess.check_call(["dunstctl", "set-paused", "true"])

    lock_invocation = ["i3lock", "-n", "-c", "000000", "-f"]
    if lockimage.is_file():
        lock_invocation.extend(["-i", lockimage])

    lockproc = subprocess.Popen(lock_invocation)

    if args.suspend:
        subprocess.check_call(["systemctl", "suspend"])

    lockproc.wait()

    if dunst_active:
        subprocess.check_call(["dunstctl", "set-paused", "false"])

if __name__ == "__main__":
    main()
